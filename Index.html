<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Putzplan mit Signatur (Graustufenanzeige)</title>
<style>
  body {
    font-family: Arial, sans-serif;
    background: #e4f0e2;
    margin: 0; padding: 0;
    color: #034d21;
  }
  header {
    background: #116622;
    color: white;
    padding: 10px 20px;
    display: flex; align-items: center; justify-content: space-between;
  }
  header button {
    background: #36a632;
    border: none;
    color: white;
    padding: 6px 12px;
    cursor: pointer;
    border-radius: 4px;
  }
  header button:hover {
    background: #2a8b2a;
  }
  #dateDisplay {
    font-weight: bold;
    font-size: 1.3em;
  }

  main {
    max-width: 900px;
    margin: 20px auto;
    background: white;
    border-radius: 6px;
    box-shadow: 0 0 10px #aaa;
    padding: 15px 20px;
  }

  section.shift {
    margin-bottom: 25px;
  }
  section.shift h2 {
    border-bottom: 2px solid #116622;
    padding-bottom: 5px;
    margin-bottom: 10px;
  }
  ul.task-list {
    list-style: none;
    padding: 0;
  }
  ul.task-list li {
    background: #d0e6c7;
    margin-bottom: 8px;
    padding: 10px 12px;
    border-radius: 5px;
    position: relative;
    user-select: none;
    font-weight: 600;
  }
  ul.task-list li .sign-icon {
    position: absolute;
    right: 10px;
    top: 10px;
    cursor: pointer;
    font-size: 20px;
  }
  ul.task-list li.signed {
    background: #a0c978;
  }
  /* Signatur Popup */
  #signatureOverlay {
    position: fixed;
    top:0; left:0; right:0; bottom:0;
    background: rgba(0,0,0,0.4);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 10000;
  }
  #signatureDialog {
    background: white;
    padding: 15px 20px 25px;
    border-radius: 6px;
    max-width: 400px;
    width: 95%;
    box-shadow: 0 0 10px #444;
    text-align: center;
  }
  #signatureCanvas {
    border: 1px solid #444;
    border-radius: 4px;
    touch-action: none; /* für Touch */
    background: #f9f9f9;
  }
  #signatureDialog button {
    margin: 12px 8px 0 8px;
    padding: 8px 16px;
    background: #116622;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
  }
  #signatureDialog button:disabled {
    background: #9bcf91;
    cursor: not-allowed;
  }
</style>
</head>
<body>

<header>
  <button id="prevDayBtn" title="Vorheriger Tag">◀</button>
  <div id="dateDisplay">Datum</div>
  <button id="nextDayBtn" title="Nächster Tag">▶</button>
</header>

<main>
  <h1>Putzplan für den <span id="displayedDate">...</span></h1>

  <section id="frueh" class="shift">
    <h2>Frühschicht</h2>
    <ul class="task-list" id="fruehTasks"></ul>
  </section>

  <section id="tag" class="shift">
    <h2>Tagesschicht</h2>
    <ul class="task-list" id="tagTasks"></ul>
  </section>

  <section id="spaet" class="shift">
    <h2>Spätschicht</h2>
    <ul class="task-list" id="spaetTasks"></ul>
  </section>
</main>

<!-- Signatur Popup -->
<div id="signatureOverlay">
  <div id="signatureDialog">
    <h3>Unterschrift für Aufgabe</h3>
    <canvas id="signatureCanvas" width="350" height="150"></canvas>
    <div>
      <button id="saveBtn">Speichern</button>
      <button id="clearBtn">Löschen</button>
      <button id="cancelBtn">Abbrechen</button>
    </div>
  </div>
</div>

<script>
(() => {
  // DOM Elemente
  const prevDayBtn = document.getElementById("prevDayBtn");
  const nextDayBtn = document.getElementById("nextDayBtn");
  const dateDisplay = document.getElementById("dateDisplay");
  const displayedDateSpan = document.getElementById("displayedDate");

  const fruehTasksList = document.getElementById("fruehTasks");
  const tagTasksList = document.getElementById("tagTasks");
  const spaetTasksList = document.getElementById("spaetTasks");

  const signatureOverlay = document.getElementById("signatureOverlay");
  const signatureDialog = document.getElementById("signatureDialog");
  const canvas = document.getElementById("signatureCanvas");
  const ctx = canvas.getContext("2d");
  const saveBtn = document.getElementById("saveBtn");
  const clearBtn = document.getElementById("clearBtn");
  const cancelBtn = document.getElementById("cancelBtn");

  let currentDate = new Date();
  let currentShift = null;  // "frueh", "tag", "spaet"
  let currentTask = null;

  // Beispielaufgaben, je Schicht
  // Hier kannst du die Aufgaben individuell anpassen / erweitern
  const taskTemplate = {
    frueh: ["Müll rausbringen", "Böden wischen", "Küche aufräumen"],
    tag: ["Fenster putzen", "Tische abwischen", "Badezimmer reinigen"],
    spaet: ["Müll entsorgen", "Staubsaugen", "Geräte reinigen"]
  };

  // Hilfsfunktion Datum formatieren: "TT.MM.JJJJ"
  function formatDate(date) {
    return date.toLocaleDateString("de-DE");
  }

  // Speichern der Signaturen & Tasks im localStorage mit Key: "putzplan_YYYY-MM-DD"
  function getStorageKey(date) {
    return "putzplan_" + date.toISOString().slice(0,10); // z.B. "putzplan_2025-05-28"
  }

  // Lade Daten für Datum
  // Struktur: { frueh: { "Aufgabe 1": "dataURL" }, tag: {...}, spaet: {...} }
  function loadData(date) {
    const key = getStorageKey(date);
    const raw = localStorage.getItem(key);
    if (raw) {
      try {
        return JSON.parse(raw);
      } catch {
        return {};
      }
    }
    return {};
  }

  // Speichern Daten
  function saveData(date, data) {
    const key = getStorageKey(date);
    localStorage.setItem(key, JSON.stringify(data));
  }

  // Canvas Zeichnen: Graustufen-Bild anzeigen
  function loadAndDrawGrayImage(dataUrl) {
    const img = new Image();
    img.onload = () => {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

      // Graustufen-Filter
      const imgData = ctx.getImageData(0, 0, canvas.width, canvas.height);
      const d = imgData.data;
      for (let i = 0; i < d.length; i += 4) {
        const avg = 0.3*d[i] + 0.59*d[i+1] + 0.11*d[i+2];
        d[i] = d[i+1] = d[i+2] = avg * 0.5 + 128 * 0.5; // leichter Grauton
        // Alpha bleibt gleich
      }
      ctx.putImageData(imgData, 0, 0);
    };
    img.src = dataUrl;
  }

  // Zeichnen erlauben oder sperren
  function disableCanvas(disable) {
    canvas.style.pointerEvents = disable ? "none" : "auto";
  }

  // Prüfen, ob Canvas leer (unterschrieben)
  function isCanvasBlank(cnv) {
    const blank = document.createElement("canvas");
    blank.width = cnv.width;
    blank.height = cnv.height;
    return cnv.toDataURL() === blank.toDataURL();
  }

  // Zeichnen Setup
  let drawing = false;
  let lastX = 0;
  let lastY = 0;

  function startDrawing(e) {
    drawing = true;
    const rect = canvas.getBoundingClientRect();
    lastX = (e.clientX || e.touches[0].clientX) - rect.left;
    lastY = (e.clientY || e.touches[0].clientY) - rect.top;
  }
  function draw(e) {
    if (!drawing) return;
    e.preventDefault();
    const rect = canvas.getBoundingClientRect();
    const x = (e.clientX || e.touches[0].clientX) - rect.left;
    const y = (e.clientY || e.touches[0].clientY) - rect.top;
    ctx.strokeStyle = "#116622";
    ctx.lineWidth = 2;
    ctx.lineCap = "round";
    ctx.beginPath();
    ctx.moveTo(lastX, lastY);
    ctx.lineTo(x, y);
    ctx.stroke();
    lastX = x;
    lastY = y;
  }
  function stopDrawing() {
    drawing = false;
  }

  canvas.addEventListener("mousedown", startDrawing);
  canvas.addEventListener("mousemove", draw);
  canvas.addEventListener("mouseup", stopDrawing);
  canvas.addEventListener("mouseout", stopDrawing);
  canvas.addEventListener("touchstart", startDrawing);
  canvas.addEventListener("touchmove", draw);
  canvas.addEventListener("touchend", stopDrawing);

  // Signatur Popup öffnen
  function openSignatureDialog(shift, taskName) {
    currentShift = shift;
    currentTask = taskName;
    signatureOverlay.style.display = "flex";
    ctx.clearRect(0, 0, canvas.width, canvas.height);

    const data = loadData(currentDate);
    const signatureDataUrl = data[shift]?.[taskName];
    if (signatureDataUrl) {
      disableCanvas(true);
      loadAndDrawGrayImage(signatureDataUrl);
      saveBtn.disabled = true;
      clearBtn.disabled = true;
    } else {
      disableCanvas(false);
      saveBtn.disabled = false;
      clearBtn.disabled = false;
    }
  }

  function closeSignatureDialog() {
    signatureOverlay.style.display = "none";
    currentShift = null;
    currentTask = null;
    ctx.clearRect(0, 0, canvas.width, canvas.height);
  }

  saveBtn.addEventListener("click", () => {
    if (isCanvasBlank(canvas)) {
      alert("Bitte erst eine Unterschrift setzen oder Abbrechen klicken.");
      return;
    }
    const data = loadData(currentDate
