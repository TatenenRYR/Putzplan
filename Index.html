<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Putzplan mit Unterschrift</title>
<style>
  body {
    font-family: Arial, sans-serif;
    max-width: 600px;
    margin: 20px auto;
  }
  h2 {
    margin-bottom: 0;
  }
  .nav-tabs {
    margin: 10px 0 20px;
    display: flex;
    gap: 10px;
  }
  .nav-tabs button {
    flex: 1;
    padding: 8px;
    cursor: pointer;
    border: 1px solid #ccc;
    background: #eee;
    border-radius: 4px;
  }
  .nav-tabs button.active {
    background: #4caf50;
    color: white;
    font-weight: bold;
  }
  .task-list {
    min-height: 80px;
    border: 1px solid #ccc;
    padding: 10px;
    border-radius: 6px;
    background: #fafafa;
  }
  .task {
    margin-bottom: 10px;
    padding: 8px 40px 8px 8px;
    border: 1px solid #ccc;
    border-radius: 4px;
    position: relative;
    background: white;
  }
  .sign-icon {
    position: absolute;
    right: 8px;
    top: 50%;
    transform: translateY(-50%);
    cursor: pointer;
    font-size: 18px;
    user-select: none;
  }
  .signature-image img {
    max-height: 70px;
    border: 1px solid #ccc;
    margin-top: 6px;
    border-radius: 4px;
  }
  button.add-task {
    margin-top: 10px;
    padding: 8px 12px;
    border: none;
    background: #4caf50;
    color: white;
    font-weight: bold;
    border-radius: 5px;
    cursor: pointer;
  }
  button.add-task:hover {
    background: #45a045;
  }
  /* Signatur Popup */
  .signature-popup {
    position: fixed;
    top: 20%;
    left: 50%;
    transform: translateX(-50%);
    background: white;
    border: 1px solid #666;
    padding: 15px;
    box-shadow: 0 4px 10px rgba(0,0,0,0.2);
    z-index: 10000;
    border-radius: 8px;
  }
  .signature-popup button {
    margin-top: 10px;
    margin-right: 8px;
    padding: 6px 12px;
    font-weight: bold;
    cursor: pointer;
  }
  canvas.signature-canvas {
    border: 2px solid #333;
    border-radius: 6px;
    touch-action: none;
    background: #fff;
  }
</style>
</head>
<body>

<h2>Putzplan</h2>

<div class="nav-tabs">
  <button id="btn-frueh" class="active" onclick="showSection('frueh')">Fr√ºhdienst</button>
  <button id="btn-tag" onclick="showSection('tag')">Tagdienst</button>
  <button id="btn-spaet" onclick="showSection('spaet')">Sp√§tdienst</button>
</div>

<div id="frueh" class="task-section">
  <div class="task-list" id="frueh-list"></div>
  <button class="add-task" onclick="addTask('frueh-list')">+ Aufgabe hinzuf√ºgen</button>
</div>

<div id="tag" class="task-section" style="display:none;">
  <div class="task-list" id="tag-list"></div>
  <button class="add-task" onclick="addTask('tag-list')">+ Aufgabe hinzuf√ºgen</button>
</div>

<div id="spaet" class="task-section" style="display:none;">
  <div class="task-list" id="spaet-list"></div>
  <button class="add-task" onclick="addTask('spaet-list')">+ Aufgabe hinzuf√ºgen</button>
</div>

<!-- Signatur Popup -->
<div id="signaturePopup" class="signature-popup" style="display:none;">
  <canvas id="signatureCanvas" class="signature-canvas" width="320" height="160"></canvas><br />
  <button onclick="saveSignature()">Speichern</button>
  <button onclick="closeSignaturePopup()">Abbrechen</button>
</div>

<script>
  // Navigation Tabs
  function showSection(section) {
    ['frueh','tag','spaet'].forEach(sec => {
      document.getElementById(sec).style.display = sec === section ? 'block' : 'none';
      document.getElementById('btn-' + sec).classList.toggle('active', sec === section);
    });
  }

  // Aufgabenverwaltung
  let currentTaskId = null;
  let isDrawing = false;
  let lastX = 0;
  let lastY = 0;

  const canvas = document.getElementById('signatureCanvas');
  const ctx = canvas.getContext('2d');
  ctx.strokeStyle = '#000';
  ctx.lineWidth = 2;
  ctx.lineCap = 'round';

  function addTask(listId) {
    const taskList = document.getElementById(listId);
    const taskId = 'task-' + Date.now();

    // Standard-Aufgabenname (du kannst das anpassen oder per Prompt fragen)
    const taskName = prompt('Aufgabenbeschreibung eingeben:', 'Neue Aufgabe');
    if (!taskName) return;

    const taskDiv = document.createElement('div');
    taskDiv.classList.add('task');
    taskDiv.id = taskId;
    taskDiv.innerHTML = `
      ${taskName}
      <span class="sign-icon" title="Unterschreiben" onclick="openSignaturePopup('${taskId}')">üñäÔ∏è</span>
      <div class="signature-image"></div>
    `;

    taskList.appendChild(taskDiv);

    loadSignature(taskId);
    saveTasksToStorage();
  }

  // Signatur Popup √∂ffnen
  function openSignaturePopup(taskId) {
    currentTaskId = taskId;
    ctx.clearRect(0, 0, canvas.width, canvas.height);

    // Lade ggf. vorhandene Signatur in Canvas
    const dataURL = localStorage.getItem('signature_' + taskId);
    if (dataURL) {
      const img = new Image();
      img.onload = () => ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
      img.src = dataURL;
    }

    document.getElementById('signaturePopup').style.display = 'block';
  }
  function closeSignaturePopup() {
    document.getElementById('signaturePopup').style.display = 'none';
    currentTaskId = null;
  }

  // Canvas Zeichnen
  canvas.addEventListener('mousedown', startDrawing);
  canvas.addEventListener('mousemove', draw);
  canvas.addEventListener('mouseup', stopDrawing);
  canvas.addEventListener('mouseout', stopDrawing);

  canvas.addEventListener('touchstart', startDrawingTouch, {passive:false});
  canvas.addEventListener('touchmove', drawTouch, {passive:false});
  canvas.addEventListener('touchend', stopDrawing);

  function startDrawing(e) {
    isDrawing = true;
    lastX = e.offsetX;
    lastY = e.offsetY;
  }
  function draw(e) {
    if (!isDrawing) return;
    ctx.beginPath();
    ctx.moveTo(lastX, lastY);
    ctx.lineTo(e.offsetX, e.offsetY);
    ctx.stroke();
    lastX = e.offsetX;
    lastY = e.offsetY;
  }
  function stopDrawing() {
    isDrawing = false;
  }
  // Touch
  function getTouchPos(touchEvent) {
    const rect = canvas.getBoundingClientRect();
    return {
      x: touchEvent.touches[0].clientX - rect.left,
      y: touchEvent.touches[0].clientY - rect.top
    };
  }
  function startDrawingTouch(e) {
    e.preventDefault();
    isDrawing = true;
    const pos = getTouchPos(e);
    lastX = pos.x;
    lastY = pos.y;
  }
  function drawTouch(e) {
    e.preventDefault();
    if (!isDrawing) return;
    const pos = getTouchPos(e);
    ctx.beginPath();
    ctx.moveTo(lastX, lastY);
    ctx.lineTo(pos.x, pos.y);
    ctx.stroke();
    lastX = pos.x;
    lastY = pos.y;
  }

  // Signatur speichern
  function saveSignature() {
    if (!currentTaskId) return;
    const dataURL = canvas.toDataURL();
    localStorage.setItem('signature_' + currentTaskId, dataURL);

    loadSignature(currentTaskId);
    closeSignaturePopup();
  }

  // Signatur in Aufgabe anzeigen
  function loadSignature(taskId) {
    const dataURL = localStorage.getItem('signature_' + taskId);
    if (dataURL) {
      const taskDiv = document.getElementById(taskId);
      if (taskDiv) {
        const imgDiv = taskDiv.querySelector('.signature-image');
        if (imgDiv) {
          imgDiv.innerHTML = `<img src="${dataURL}" alt="Unterschrift" />`;
        }
      }
    }
  }

  // Aufgaben & Signaturen im localStorage speichern / laden
  function saveTasksToStorage() {
    const allTasks = {};
    ['frueh-list','tag-list','spaet-list'].forEach(listId => {
      const list = document.getElementById(listId);
      const tasks = [];
      list.querySelectorAll('.task').forEach(task => {
        tasks.push({
          id: task.id,
          text: task.childNodes[0].textContent.trim()
        });
      });
      allTasks[listId] = tasks;
    });
    localStorage.setItem('putzplan-tasks', JSON.stringify(allTasks));
  }
  function loadTasksFromStorage() {
    const allTasks = JSON.parse(localStorage.getItem('putzplan-tasks'));
    if (!allTasks) return;
    Object.entries(allTasks).forEach(([listId, tasks]) => {
      const list = document.getElementById(listId);
      list.innerHTML = '';
      tasks.forEach(t => {
        const taskDiv = document.createElement('div');
        taskDiv.classList.add('task');
        taskDiv.id = t.id;
        taskDiv.innerHTML = `
          ${t.text}
          <span class="sign-icon" title="Unterschreiben" onclick="openSignaturePopup('${t.id}')">üñäÔ∏è</span>
          <div class="signature-image"></div>
        `;
        list.appendChild(taskDiv);
        loadSignature(t.id);
      });
    });
  }

  // Beim Start die Aufgaben laden
  window.onload = () => {
    loadTasksFromStorage();
  };

  // Beim Aufgaben hinzuf√ºgen speichern
  document.querySelectorAll('.add-task').forEach(btn => {
    btn.addEventListener('click', () => {
      // kleiner Delay, damit addTask() fertig wird, dann speichern
      setTimeout(() => saveTasksToStorage(), 200);
    });
  });
</script>

</body>
</html>
