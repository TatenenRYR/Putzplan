<style>
  .task {
    margin-bottom: 10px;
    padding: 5px;
    border: 1px solid #ccc;
    position: relative;
  }
  .sign-icon {
    position: absolute;
    right: 5px;
    top: 5px;
    cursor: pointer;
  }
  .signature-canvas {
    border: 1px solid #000;
    touch-action: none; /* Wichtig f√ºr Touchscreen */
  }
  .signature-popup {
    position: fixed;
    top: 20%;
    left: 50%;
    transform: translateX(-50%);
    background: white;
    border: 1px solid #666;
    padding: 10px;
    z-index: 1000;
  }
  .signature-popup button {
    margin-top: 5px;
  }
</style>

<div id="tag" class="task-list"></div>
<button onclick="addTask('tag')">+ Aufgabe hinzuf√ºgen</button>

<div id="signaturePopup" class="signature-popup" style="display:none;">
  <canvas id="signatureCanvas" class="signature-canvas" width="300" height="150"></canvas>
  <br>
  <button onclick="saveSignature()">Speichern</button>
  <button onclick="closeSignaturePopup()">Abbrechen</button>
</div>

<script>
  let currentTaskId = null;
  let isDrawing = false;
  let lastX = 0;
  let lastY = 0;
  const canvas = document.getElementById('signatureCanvas');
  const ctx = canvas.getContext('2d');

  function addTask(section) {
    const taskList = document.getElementById(section);
    const taskId = 'task-' + Date.now();

    const taskDiv = document.createElement('div');
    taskDiv.classList.add('task');
    taskDiv.id = taskId;

    // Beispiel-Aufgabenname
    taskDiv.innerHTML = `
      Aufgabe ${taskList.children.length + 1}
      <span class="sign-icon" title="Unterschreiben" onclick="openSignaturePopup('${taskId}')">üñäÔ∏è</span>
      <div class="signature-image" style="margin-top:5px;"></div>
    `;

    taskList.appendChild(taskDiv);

    // Falls eine Unterschrift bereits gespeichert ist, anzeigen
    loadSignature(taskId);
  }

  function openSignaturePopup(taskId) {
    currentTaskId = taskId;
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    document.getElementById('signaturePopup').style.display = 'block';
  }

  function closeSignaturePopup() {
    document.getElementById('signaturePopup').style.display = 'none';
    currentTaskId = null;
  }

  // Zeichnen im Canvas (Touch & Mouse)
  canvas.addEventListener('mousedown', startDrawing);
  canvas.addEventListener('mousemove', draw);
  canvas.addEventListener('mouseup', stopDrawing);
  canvas.addEventListener('mouseout', stopDrawing);

  canvas.addEventListener('touchstart', startDrawingTouch);
  canvas.addEventListener('touchmove', drawTouch);
  canvas.addEventListener('touchend', stopDrawing);

  function startDrawing(e) {
    isDrawing = true;
    lastX = e.offsetX;
    lastY = e.offsetY;
  }
  function draw(e) {
    if (!isDrawing) return;
    ctx.beginPath();
    ctx.moveTo(lastX, lastY);
    ctx.lineTo(e.offsetX, e.offsetY);
    ctx.stroke();
    lastX = e.offsetX;
    lastY = e.offsetY;
  }
  function stopDrawing() {
    isDrawing = false;
  }

  // Touch-Version
  function getTouchPos(touchEvent) {
    const rect = canvas.getBoundingClientRect();
    return {
      x: touchEvent.touches[0].clientX - rect.left,
      y: touchEvent.touches[0].clientY - rect.top
    };
  }
  function startDrawingTouch(e) {
    e.preventDefault();
    isDrawing = true;
    const pos = getTouchPos(e);
    lastX = pos.x;
    lastY = pos.y;
  }
  function drawTouch(e) {
    e.preventDefault();
    if (!isDrawing) return;
    const pos = getTouchPos(e);
    ctx.beginPath();
    ctx.moveTo(lastX, lastY);
    ctx.lineTo(pos.x, pos.y);
    ctx.stroke();
    lastX = pos.x;
    lastY = pos.y;
  }

  function saveSignature() {
    if (!currentTaskId) return;

    // Signatur als Bild speichern (Base64)
    const dataURL = canvas.toDataURL();
    localStorage.setItem('signature_' + currentTaskId, dataURL);

    // Bild in der Aufgabe anzeigen
    loadSignature(currentTaskId);

    closeSignaturePopup();
  }

  function loadSignature(taskId) {
    const dataURL = localStorage.getItem('signature_' + taskId);
    if (dataURL) {
      const taskDiv = document.getElementById(taskId);
      if (taskDiv) {
        let imgDiv = taskDiv.querySelector('.signature-image');
        if (!imgDiv) {
          imgDiv = document.createElement('div');
          imgDiv.className = 'signature-image';
          taskDiv.appendChild(imgDiv);
        }
        imgDiv.innerHTML = `<img src="${dataURL}" alt="Unterschrift" style="max-width:100%; max-height:80px; border:1px solid #ccc;">`;
      }
    }
  }
</script>
