<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8" />
<title>Putzplan mit Admin und Unterschrift</title>
<style>
  body {
    font-family: Arial, sans-serif;
    background: #e8f5e9;
    color: #2e7d32;
    margin: 20px;
  }
  #adminToggle {
    position: fixed;
    top: 15px;
    right: 15px;
    padding: 10px 18px;
    font-weight: bold;
    cursor: pointer;
    background: #2e7d32;
    color: white;
    border: none;
    border-radius: 6px;
  }
  section {
    background: #c8e6c9;
    margin-bottom: 15px;
    padding: 15px;
    border-radius: 8px;
  }
  h2 {
    margin-top: 0;
  }
  .task {
    background: #a5d6a7;
    margin-bottom: 8px;
    padding: 7px 10px;
    border-radius: 5px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
  }
  .task input[type=text] {
    flex-grow: 1;
    border: 1px solid #1b5e20;
    border-radius: 4px;
    padding: 4px 7px;
    font-size: 1em;
  }
  button.addTaskBtn {
    margin-top: 10px;
    background: #1b5e20;
    color: white;
    border: none;
    padding: 8px 15px;
    border-radius: 5px;
    cursor: pointer;
  }
  button.delTaskBtn {
    background: #a52714;
    border: none;
    color: white;
    font-weight: bold;
    padding: 4px 8px;
    border-radius: 4px;
    cursor: pointer;
    margin-left: 10px;
  }
  button.signBtn {
    background: #3a8e41;
    border: none;
    color: white;
    font-weight: bold;
    padding: 4px 8px;
    border-radius: 4px;
    cursor: pointer;
    margin-left: 10px;
  }
  .signature-img {
    max-height: 50px;
    margin-left: 10px;
    border: 1px solid #1b5e20;
    border-radius: 4px;
  }

  /* Popup */
  #signaturePopup {
    position: fixed;
    top: 20%;
    left: 50%;
    transform: translateX(-50%);
    background: white;
    border: 1px solid #666;
    padding: 10px;
    z-index: 10000;
    display: none;
    box-shadow: 0 0 10px rgba(0,0,0,0.5);
    border-radius: 8px;
  }
  #signatureCanvas {
    border: 1px solid #000;
    touch-action: none;
  }
  #signaturePopup button {
    margin-top: 5px;
    margin-right: 10px;
  }
</style>
</head>
<body>

<button id="adminToggle">Adminmodus: Aus</button>

<section id="shift-frueh">
  <h2>Frühschicht</h2>
  <div class="tasks"></div>
  <button class="addTaskBtn" disabled>+ Aufgabe hinzufügen</button>
</section>

<section id="shift-tag">
  <h2>Tagesschicht</h2>
  <div class="tasks"></div>
  <button class="addTaskBtn" disabled>+ Aufgabe hinzufügen</button>
</section>

<section id="shift-spaet">
  <h2>Spätschicht</h2>
  <div class="tasks"></div>
  <button class="addTaskBtn" disabled>+ Aufgabe hinzufügen</button>
</section>

<!-- Signatur Popup -->
<div id="signaturePopup">
  <canvas id="signatureCanvas" width="300" height="150"></canvas><br/>
  <button id="saveSignatureBtn">Speichern</button>
  <button id="clearSignatureBtn">Löschen</button>
  <button id="closeSignatureBtn">Abbrechen</button>
</div>

<script>
(() => {
  const shifts = ['frueh', 'tag', 'spaet'];
  let adminMode = false;

  const adminToggleBtn = document.getElementById('adminToggle');

  // Signature popup elements
  const signaturePopup = document.getElementById('signaturePopup');
  const signatureCanvas = document.getElementById('signatureCanvas');
  const saveSignatureBtn = document.getElementById('saveSignatureBtn');
  const clearSignatureBtn = document.getElementById('clearSignatureBtn');
  const closeSignatureBtn = document.getElementById('closeSignatureBtn');
  const ctx = signatureCanvas.getContext('2d');

  let isDrawing = false;
  let lastX = 0, lastY = 0;
  let currentSignTaskId = null; // Format: shift_idx

  adminToggleBtn.onclick = () => {
    adminMode = !adminMode;
    adminToggleBtn.textContent = adminMode ? 'Adminmodus: An' : 'Adminmodus: Aus';
    document.querySelectorAll('.addTaskBtn').forEach(btn => btn.disabled = !adminMode);
    renderAllTasks();
  };

  // LocalStorage Schlüssel
  function tasksKey(shift) {
    return `tasks_${shift}`;
  }
  function sigKey(shift, idx) {
    return `signature_${shift}_${idx}`;
  }

  // Laden & Speichern Aufgaben
  function loadTasks(shift) {
    const raw = localStorage.getItem(tasksKey(shift));
    if(!raw) return [];
    try { return JSON.parse(raw); } catch { return []; }
  }
  function saveTasks(shift, tasks) {
    localStorage.setItem(tasksKey(shift), JSON.stringify(tasks));
  }

  // Laden & Speichern Signaturen
  function loadSignature(shift, idx) {
    return localStorage.getItem(sigKey(shift, idx));
  }
  function saveSignature(shift, idx, dataUrl) {
    localStorage.setItem(sigKey(shift, idx), dataUrl);
  }

  // Rendern der Aufgaben
  function renderTasks(shift) {
    const container = document.querySelector(`#shift-${shift} .tasks`);
    container.innerHTML = '';
    const tasks = loadTasks(shift);

    tasks.forEach((task, idx) => {
      const taskDiv = document.createElement('div');
      taskDiv.className = 'task';

      if(adminMode){
        // Eingabefeld zum Bearbeiten
        const input = document.createElement('input');
        input.type = 'text';
        input.value = task;
        input.oninput = () => {
          const newTasks = loadTasks(shift);
          newTasks[idx] = input.value;
          saveTasks(shift, newTasks);
        };
        taskDiv.appendChild(input);

        // Löschen Button
        const delBtn = document.createElement('button');
        delBtn.className = 'delTaskBtn';
        delBtn.textContent = '×';
        delBtn.title = 'Aufgabe löschen';
        delBtn.onclick = () => {
          const newTasks = loadTasks(shift);
          newTasks.splice(idx,1);
          saveTasks(shift, newTasks);
          // Lösche auch Signatur dazu
          localStorage.removeItem(sigKey(shift, idx));
          renderTasks(shift);
        };
        taskDiv.appendChild(delBtn);

      } else {
        // Nur Text anzeigen
        const span = document.createElement('span');
        span.textContent = task;
        taskDiv.appendChild(span);
      }

      // Unterschrift Button (immer sichtbar)
      const signBtn = document.createElement('button');
      signBtn.className = 'signBtn';
      signBtn.textContent = '✍️ Unterschreiben';
      signBtn.title = 'Unterschrift setzen/ansehen';
      signBtn.onclick = () => openSignaturePopup(shift, idx);
      taskDiv.appendChild(signBtn);

      // Signatur-Bild (wenn vorhanden)
      const sigData = loadSignature(shift, idx);
      if(sigData) {
        const img = document.createElement('img');
        img.className = 'signature-img';
        img.src = sigData;
        img.alt = 'Unterschrift';
        taskDiv.appendChild(img);
      }

      container.appendChild(taskDiv);
    });
  }

  function renderAllTasks() {
    shifts.forEach(renderTasks);
  }

  // Add-Task Buttons
  document.querySelectorAll('.addTaskBtn').forEach(btn => {
    btn.onclick = e => {
      const shift = e.target.closest('section').id.replace('shift-', '');
      const tasks = loadTasks(shift);
      tasks.push('Neue Aufgabe');
      saveTasks(shift, tasks);
      renderTasks(shift);
    };
  });

  // --- Signatur Popup Funktionen ---
  function openSignaturePopup(shift, idx) {
    currentSignTaskId = {shift, idx};
    ctx.clearRect(0, 0, signatureCanvas.width, signatureCanvas.height);

    // Signatur laden wenn vorhanden
    const dataUrl = loadSignature(shift, idx);
    if(dataUrl){
      const img = new Image();
      img.onload = () => ctx.drawImage(img,0,0,signatureCanvas.width,signatureCanvas.height);
      img.src = dataUrl;
    }

    signaturePopup.style.display = 'block';
  }

  function closeSignaturePopup() {
    signaturePopup.style.display = 'none';
    currentSignTaskId = null;
  }

  // Zeichnen Logik
  function startDrawing(e) {
    e.preventDefault();
    isDrawing = true;
    const pos = getPos(e);
    lastX = pos.x;
    lastY = pos.y;
  }
  function draw(e) {
    if(!isDrawing) return;
    e.preventDefault();
    const pos = getPos(e);
    ctx.beginPath();
    ctx.moveTo(lastX,lastY);
    ctx.lineTo(pos.x,pos.y);
    ctx.stroke();
    lastX = pos.x;
    lastY = pos.y;
  }
  function stopDrawing(e) {
    if(isDrawing) {
      e.preventDefault();
      isDrawing = false;
    }
  }
  function getPos(e){
    const rect = signatureCanvas.getBoundingClientRect();
    if(e.touches){
      return {
        x: e.touches[0].clientX - rect.left,
        y: e.touches[0].clientY - rect.top
      };
    } else {
      return {
        x: e.clientX - rect.left,
        y: e.clientY - rect.top
      };
    }
  }

  signatureCanvas.addEventListener('mousedown', startDrawing);
  signatureCanvas.addEventListener('mousemove', draw);
  signatureCanvas.addEventListener('mouseup', stopDrawing);
  signatureCanvas.addEventListener('mouseout', stopDrawing);

  signatureCanvas.addEventListener('touchstart', startDrawing);
  signatureCanvas.addEventListener('touchmove', draw);
  signatureCanvas.addEventListener('touchend',
