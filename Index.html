<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Putzplan</title>
<style>
  body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: #e8f5e9;
    color: #2e7d32;
    margin: 0; padding: 0;
    display: flex;
    flex-direction: column;
    min-height: 100vh;
  }
  header {
    background: #a5d6a7;
    padding: 10px 20px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    color: #1b5e20;
    flex-wrap: wrap;
  }
  header h1 {
    margin: 0;
    font-weight: 700;
    font-size: 1.5rem;
  }
  .date-nav {
    display: flex;
    align-items: center;
    gap: 15px;
    font-weight: 600;
    flex-wrap: wrap;
  }
  .date-nav button {
    background: #2e7d32;
    border: none;
    color: white;
    padding: 5px 10px;
    font-size: 1rem;
    cursor: pointer;
    border-radius: 4px;
  }
  .date-nav button:disabled {
    background: #9e9e9e;
    cursor: default;
  }
  main {
    flex: 1;
    padding: 20px;
    max-width: 960px;
    margin: auto;
    display: flex;
    flex-direction: column;
    gap: 20px;
  }
  section {
    background: white;
    border-radius: 8px;
    box-shadow: 0 0 10px #a5d6a7aa;
    padding: 15px;
    display: flex;
    flex-direction: column;
  }
  section h2 {
    margin-top: 0;
    text-align: center;
    color: #1b5e20;
  }
  .shift {
    max-height: 320px;
    overflow-y: auto;
    margin-bottom: 10px;
  }
  .task {
    background: #c8e6c9;
    margin-bottom: 10px;
    padding: 10px 12px;
    border-radius: 6px;
    position: relative;
    display: flex;
    flex-direction: column;
  }
  .task input.title-input {
    font-size: 1rem;
    font-weight: 600;
    border: none;
    background: transparent;
    color: #1b5e20;
    width: 100%;
    outline: none;
  }
  .task input.title-input[readonly] {
    cursor: default;
  }
  .task .buttons {
    margin-top: 8px;
    display: flex;
    gap: 8px;
    align-items: center;
  }
  .sign-icon, .delete-icon {
    cursor: pointer;
    user-select: none;
    font-size: 1.2rem;
    padding: 4px 6px;
    border-radius: 4px;
    background: #81c784;
    color: white;
    transition: background-color 0.3s ease;
    border: none;
  }
  .sign-icon:hover {
    background: #4caf50;
  }
  .delete-icon:hover {
    background: #d32f2f;
  }
  .delete-icon {
    display: none;
  }
  .task.admin-active .delete-icon {
    display: inline-block;
  }
  .signature-image img {
    max-height: 60px;
    border: 1px solid #4caf50;
    border-radius: 4px;
    margin-top: 8px;
  }
  button.admin-only {
    background: #2e7d32;
    color: white;
    border: none;
    padding: 8px 12px;
    border-radius: 6px;
    cursor: pointer;
    font-weight: 600;
    transition: background-color 0.3s ease;
    align-self: center;
  }
  button.admin-only:disabled {
    background: #a5d6a7;
    cursor: default;
  }
  button.admin-only:hover:not(:disabled) {
    background: #1b5e20;
  }
  /* Signatur Popup */
  .signature-popup {
    position: fixed;
    top: 20%;
    left: 50%;
    transform: translateX(-50%);
    background: white;
    border: 2px solid #2e7d32;
    border-radius: 10px;
    padding: 15px;
    z-index: 1100;
    box-shadow: 0 4px 10px rgba(0,0,0,0.3);
    display: none;
    width: 320px;
  }
  .signature-popup h3 {
    margin-top: 0;
    color: #1b5e20;
    text-align: center;
  }
  .signature-canvas {
    border: 1px solid #4caf50;
    border-radius: 6px;
    width: 300px;
    height: 150px;
    touch-action: none;
  }
  .signature-popup label {
    font-weight: 600;
    margin-top: 10px;
    display: block;
  }
  .signature-popup input[type="text"] {
    width: 100%;
    padding: 6px 8px;
    margin-top: 4px;
    border-radius: 6px;
    border: 1px solid #4caf50;
    font-size: 1rem;
    outline: none;
  }
  .signature-popup button {
    margin-top: 12px;
    margin-right: 8px;
    padding: 8px 14px;
    border-radius: 6px;
    border: none;
    font-weight: 600;
    cursor: pointer;
    background: #2e7d32;
    color: white;
    transition: background-color 0.3s ease;
  }
  .signature-popup button:hover {
    background: #1b5e20;
  }
  /* History Popup */
  .history-popup {
    position: fixed;
    top: 15%;
    left: 50%;
    transform: translateX(-50%);
    background: white;
    border: 2px solid #2e7d32;
    border-radius: 10px;
    padding: 20px;
    z-index: 1100;
    box-shadow: 0 4px 15px rgba(0,0,0,0.4);
    display: none;
    max-height: 70vh;
    width: 500px;
    overflow-y: auto;
  }
  .history-popup h3 {
    margin-top: 0;
    color: #1b5e20;
    text-align: center;
  }
  .history-popup button.close-history {
    background: #d32f2f;
    border: none;
    padding: 6px 10px;
    border-radius: 6px;
    color: white;
    font-weight: 600;
    cursor: pointer;
    float: right;
    margin-top: -40px;
    margin-right: -10px;
  }
  .history-list div {
    border-bottom: 1px solid #a5d6a7;
    padding: 6px 0;
    font-size: 0.9rem;
  }
</style>
</head>
<body>

<header>
  <h1>Putzplan</h1>
  <div class="date-nav">
    <button id="prevDayBtn" title="Vortag">&lt;</button>
    <div id="currentDateDisplay" aria-live="polite" style="min-width:120px; text-align:center; font-weight:700;"></div>
    <button id="nextDayBtn" title="Nächster Tag">&gt;</button>
    <button id="toggleAdminBtn" style="margin-left:20px;">Administration ein/aus</button>
    <button id="openHistoryBtn">History</button>
  </div>
</header>

<main>
  <section>
    <h2>Frühschicht</h2>
    <div id="frueh" class="shift"></div>
    <button class="admin-only" id="addFruehBtn" disabled>+ Aufgabe hinzufügen</button>
  </section>
  <section>
    <h2>Tagsschicht</h2>
    <div id="tag" class="shift"></div>
    <button class="admin-only" id="addTagBtn" disabled>+ Aufgabe hinzufügen</button>
  </section>
  <section>
    <h2>Spätschicht</h2>
    <div id="spaet" class="shift"></div>
    <button class="admin-only" id="addSpaetBtn" disabled>+ Aufgabe hinzufügen</button>
  </section>
</main>

<!-- Signatur Popup -->
<div id="signaturePopup" class="signature-popup" role="dialog" aria-modal="true" aria-labelledby="signPopupTitle">
  <h3 id="signPopupTitle">Unterschrift hinzufügen</h3>
  <canvas id="signatureCanvas" class="signature-canvas" width="300" height="150"></canvas>
  <label for="signerNameInput">Name der Person</label>
  <input type="text" id="signerNameInput" autocomplete="off" />
  <div style="text-align:center;">
    <button id="saveSignBtn">Speichern</button>
    <button id="closeSignBtn">Abbrechen</button>
  </div>
</div>

<!-- History Popup -->
<div id="historyPopup" class="history-popup" role="dialog" aria-modal="true" aria-labelledby="historyTitle">
  <h3 id="historyTitle">Unterschriften History</h3>
  <button class="close-history" id="closeHistoryBtn" aria-label="History schließen">✖</button>
  <div class="history-list" id="historyList"></div>
</div>

<script>
  // Globals
  let adminMode = false;
  let currentDate = new Date();
  currentDate.setHours(0,0,0,0);
  const shifts = ['frueh', 'tag', 'spaet'];
  let currentTaskId = null; // Für Signatur popup: {shift, taskId}

  // DOM Elements
  const currentDateDisplay = document.getElementById('currentDateDisplay');
  const prevDayBtn = document.getElementById('prevDayBtn');
  const nextDayBtn = document.getElementById('nextDayBtn');
  const toggleAdminBtn = document.getElementById('toggleAdminBtn');
  const addFruehBtn = document.getElementById('addFruehBtn');
  const addTagBtn = document.getElementById('addTagBtn');
  const addSpaetBtn = document.getElementById('addSpaetBtn');

  const signaturePopup = document.getElementById('signaturePopup');
  const signatureCanvas = document.getElementById('signatureCanvas');
  const ctx = signatureCanvas.getContext('2d');
  const signerNameInput = document.getElementById('signerNameInput');
  const saveSignBtn = document.getElementById('saveSignBtn');
  const closeSignBtn = document.getElementById('closeSignBtn');

  const historyPopup = document.getElementById('historyPopup');
  const openHistoryBtn = document.getElementById('openHistoryBtn');
  const closeHistoryBtn = document.getElementById('closeHistoryBtn');
  const historyList = document.getElementById('historyList');

  // Zeichnen Signatur Variablen
  let isDrawing = false;
  let lastX = 0;
  let lastY = 0;

  // Daten-Struktur:
  // localStorage key: "putzplan"
  // Inhalt: { "YYYY-MM-DD": { frueh: [ {id, title, signature, signerName, history[]}, ...], tag: [...], spaet: [...] } }

  // --- Hilfsfunktionen ---
  function formatDate(d) {
    return d.toISOString().slice(0,10);
  }
  function formatDisplayDate(d) {
    return d.toLocaleDateString('de-DE', { weekday: 'long', day: '2-digit', month: '2-digit', year
